---
export interface Props {
  courseType?: 'adults' | 'children' | 'corporate';
  location?: string;
}

const { courseType = 'adults', location = '' } = Astro.props;
---

<div id="registrationModal" class="registration-modal" data-course-type={courseType} data-location={location}>
  <div class="modal-overlay"></div>
  <div class="modal-container">
    <button class="modal-close" aria-label="Close registration form">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>

    <!-- Progress Bar -->
    <div class="modal-progress">
      <div class="progress-bar">
        <div class="progress-fill" data-step="1"></div>
      </div>
      <div class="progress-steps">
        <div class="progress-step active current" data-step="1">
          <span class="step-number">1</span>
          <span class="step-label">Your Details</span>
        </div>
        <div class="progress-step" data-step="2">
          <span class="step-number">2</span>
          <span class="step-label">Schedule</span>
        </div>
        <div class="progress-step" data-step="3">
          <span class="step-number">3</span>
          <span class="step-label">Confirm</span>
        </div>
      </div>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">
      <!-- Side Panel (Desktop Only) -->
      <div class="modal-sidebar">
        <div class="sidebar-content">
          <div class="sidebar-top">
            <span class="sidebar-logo">British Council · Spain</span>
            <h3>Complete your booking in minutes</h3>
            <p>Secure a free 20-minute consultation so we can design a study path that matches your goals and schedule.</p>
          </div>

          <ul class="sidebar-benefits">
            <li class="benefit-item">
              <div class="benefit-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3l2.09 4.26L19 8.27l-3.5 3.41.83 4.82L12 14.77 7.67 16.5l.83-4.82L5 8.27l4.91-.99L12 3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div>
                <strong>Tailored guidance</strong>
                <span>Dedicated advisor reviews your objectives before we speak.</span>
              </div>
            </li>
            <li class="benefit-item">
              <div class="benefit-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                </svg>
              </div>
              <div>
                <strong>Weekday & weekend slots</strong>
                <span>Morning, lunchtime and evening appointments available.</span>
              </div>
            </li>
            <li class="benefit-item">
              <div class="benefit-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M12 1l3 4h4l-3 4 3 4h-4l-3 4-3-4H5l3-4-3-4h4l3-4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div>
                <strong>Recognised worldwide</strong>
                <span>British Council certification valued by universities and employers.</span>
              </div>
            </li>
          </ul>

          <div class="sidebar-metrics">
            <div class="metric-card">
              <strong>4.8/5</strong>
              <span>Student satisfaction score</span>
            </div>
            <div class="metric-card">
              <strong>12k+</strong>
              <span>Consultations booked this year</span>
            </div>
          </div>

          <div class="sidebar-testimonial">
            <div class="testimonial-avatar">A</div>
            <div>
              <p>“My advisor helped me map out a course plan that fit my work schedule in one conversation.”</p>
              <span>Ana · Business English learner</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Steps Container -->
      <div class="modal-form">
        <!-- Step 1: Contact Information -->
        <div class="form-step active" data-step="1">
          <h2>Let's get started</h2>
          <p class="step-description">Tell us a bit about yourself so we can find the perfect course for you.</p>

          <form id="step1Form" novalidate>
            <div class="form-group">
              <label for="fullName">Full Name *</label>
              <input type="text" id="fullName" name="fullName" required
                     placeholder="Enter your full name" />
              <span class="error-message"></span>
            </div>

            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" name="email" required
                     placeholder="you@example.com" />
              <span class="error-message"></span>
            </div>

            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <div class="phone-input">
                <select id="phoneCode" name="phoneCode">
                  <option value="+34">+34 (Spain)</option>
                  <option value="+44">+44 (UK)</option>
                  <option value="+1">+1 (USA)</option>
                </select>
                <input type="tel" id="phone" name="phone" required
                       placeholder="123 456 789" />
              </div>
              <span class="error-message"></span>
            </div>

            <div class="form-group">
              <label for="courseInterest">Course Type *</label>
              <select id="courseInterest" name="courseInterest" required>
                <option value="">Select a course type</option>
                <option value="adults" selected={courseType === 'adults'}>Adult Courses</option>
                <option value="children" selected={courseType === 'children'}>Children & Teens</option>
                <option value="corporate" selected={courseType === 'corporate'}>Corporate Training</option>
                <option value="online">Online Courses</option>
              </select>
              <span class="error-message"></span>
            </div>

            <!-- Children-specific fields (hidden by default) -->
            <div id="childrenFields" class="children-fields" style="display: none;">
              <div class="form-group">
                <label for="childName">Child's Name *</label>
                <input type="text" id="childName" name="childName"
                       placeholder="Enter child's full name" />
                <span class="error-message"></span>
              </div>

              <div class="form-group">
                <label for="childAge">Child's Age *</label>
                <select id="childAge" name="childAge">
                  <option value="">Select age</option>
                  {[...Array(16)].map((_, i) => (
                    <option value={i + 3}>{i + 3} years</option>
                  ))}
                </select>
                <span class="error-message"></span>
              </div>
            </div>

            <div class="form-group">
              <label for="location">Preferred Location *</label>
              <select id="location" name="location" required>
                <option value="">Select a location</option>
                <option value="madrid" selected={location === 'madrid'}>Madrid</option>
                <option value="barcelona" selected={location === 'barcelona'}>Barcelona</option>
                <option value="valencia" selected={location === 'valencia'}>Valencia</option>
                <option value="bilbao" selected={location === 'bilbao'}>Bilbao</option>
                <option value="palma" selected={location === 'palma'}>Palma</option>
                <option value="online">Online</option>
              </select>
              <span class="error-message"></span>
            </div>

            <div class="form-checkbox">
              <input type="checkbox" id="newsletter" name="newsletter" />
              <label for="newsletter">
                Send me updates about courses and special offers
              </label>
            </div>
          </form>
        </div>

        <!-- Step 2: Calendar Selection -->
        <div class="form-step" data-step="2">
          <h2>Choose your schedule</h2>
          <p class="step-description">Select a consultation time that works best for you.</p>

          <div class="calendar-container">
            <div class="calendar-header">
              <button class="calendar-nav prev" aria-label="Previous month">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                </svg>
              </button>
              <div class="calendar-month">October 2025</div>
              <button class="calendar-nav next" aria-label="Next month">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                </svg>
              </button>
            </div>

            <div class="calendar-grid">
              <div class="calendar-weekdays">
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
                <span>Sun</span>
              </div>
              <div class="calendar-days" id="calendarDays">
                <!-- Calendar days will be populated by JavaScript -->
              </div>
            </div>

            <div class="time-slots" id="timeSlots" style="display: none;">
              <h3>Available times</h3>
              <div class="slots-grid">
                <!-- Time slots will be populated by JavaScript -->
              </div>
            </div>

            <div class="flexible-option">
              <button type="button" class="flexible-btn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 8a1 1 0 01-2 0V6a1 1 0 012 0v4zm-1 4a1 1 0 100-2 1 1 0 000 2z"/>
                </svg>
                I'm flexible with timing - contact me with options
              </button>
            </div>
          </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div class="form-step" data-step="3">
          <h2>Confirm your registration</h2>
          <p class="step-description">Review your details and complete your registration.</p>

          <div class="confirmation-summary">
            <div class="summary-section">
              <h3>Your Information</h3>
              <dl class="summary-list">
                <dt>Name:</dt>
                <dd id="summaryName">-</dd>
                <dt>Email:</dt>
                <dd id="summaryEmail">-</dd>
                <dt>Phone:</dt>
                <dd id="summaryPhone">-</dd>
                <dt>Course Type:</dt>
                <dd id="summaryCourse">-</dd>
                <dt>Location:</dt>
                <dd id="summaryLocation">-</dd>
              </dl>
            </div>

            <div class="summary-section">
              <h3>Consultation Time</h3>
              <div class="appointment-card">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                <div>
                  <p id="summaryDate">-</p>
                  <p id="summaryTime">-</p>
                </div>
              </div>
            </div>

            <div class="terms-section">
              <div class="form-checkbox">
                <input type="checkbox" id="terms" name="terms" required />
                <label for="terms">
                  I have read and accept the <a href="/terms" target="_blank">Terms and Conditions</a>
                  and <a href="/privacy" target="_blank">Privacy Policy</a> *
                </label>
              </div>
              <span class="error-message"></span>
            </div>

            <div class="additional-info">
              <label for="specialRequirements">Special requirements or questions (optional)</label>
              <textarea id="specialRequirements" name="specialRequirements" rows="3"
                       placeholder="Let us know if you have any special requirements or questions"></textarea>
            </div>
          </div>
        </div>

        <!-- Success State -->
        <div class="form-success" style="display: none;">
          <div class="success-icon">
            <svg width="64" height="64" viewBox="0 0 64 64" fill="currentColor">
              <path d="M32 0C14.3 0 0 14.3 0 32s14.3 32 32 32 32-14.3 32-32S49.7 0 32 0zm-4 48L12 32l4.2-4.2L28 39.6l19.8-19.8L52 24 28 48z"/>
            </svg>
          </div>
          <h2>Registration Complete!</h2>
          <p>Thank you for registering. We've sent a confirmation email to your address.</p>
          <p class="success-detail">One of our advisors will contact you within 24 hours to finalize your enrollment.</p>

          <div class="success-actions">
            <button class="btn-primary" onclick="window.location.href='/portal'">Go to Student Portal</button>
            <button class="btn-secondary" onclick="closeRegistrationModal()">Close</button>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="form-navigation">
          <button type="button" class="btn-back" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M11 1L4 8l7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
            Back
          </button>
          <button type="button" class="btn-next">
            <span class="btn-label">Continue</span>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M5 1l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<style is:global>
  .registration-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9999;
    animation: modalFadeIn 0.35s ease;
  }

  .registration-modal.active {
    display: block;
  }

  @keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes modalRiseIn {
    from {
      opacity: 0;
      transform: translate(-50%, calc(-50% + 24px));
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%);
    }
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.55);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    z-index: 1;
  }

  .modal-container {
    position: absolute;
    top: 50%;
    left: 50%;
    width: min(1024px, calc(100% - 3rem));
    max-height: min(88vh, 900px);
    transform: translate(-50%, -50%);
    background: #ffffff;
    border-radius: 28px;
    overflow: hidden;
    box-shadow: 0 28px 80px -48px rgba(15, 23, 42, 0.4);
    display: flex;
    flex-direction: column;
    z-index: 2;
    animation: modalRiseIn 0.4s cubic-bezier(0.19, 1, 0.22, 1);
  }

  .modal-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(255, 255, 255, 0.88);
    color: #0f172a;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.2s ease;
    z-index: 5;
  }

  .modal-close:hover {
    background: rgba(37, 99, 235, 0.15);
    color: #1e3a8a;
    transform: translateY(-1px) scale(1.03);
  }

  .modal-progress {
    padding: 2rem 2.5rem 1.4rem;
    background: linear-gradient(180deg, rgba(248, 250, 255, 0.96) 0%, rgba(241, 245, 255, 0.94) 100%);
    border-bottom: 1px solid rgba(148, 163, 184, 0.18);
  }

  .progress-bar {
    position: relative;
    height: 5px;
    border-radius: 999px;
    background: rgba(30, 64, 175, 0.12);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .progress-fill {
    height: 100%;
    width: 33.33%;
    background: linear-gradient(135deg, #2563eb, #1e3a8a);
    border-radius: 999px;
    transition: width 0.3s ease-in-out;
  }

  .progress-fill[data-step="2"] { width: 66.66%; }
  .progress-fill[data-step="3"] { width: 100%; }

  .progress-steps {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1rem;
  }

  .progress-step {
    display: grid;
    grid-template-columns: auto 1fr;
    align-items: center;
    gap: 0.85rem;
    padding: 0.85rem 1rem;
    border-radius: 18px;
    background: rgba(37, 99, 235, 0.08);
    border: 1px solid transparent;
    color: rgba(15, 23, 42, 0.6);
    transition: all 0.25s ease;
    opacity: 0.55;
  }

  .progress-step.active {
    opacity: 1;
  }

  .progress-step.complete {
    background: rgba(37, 99, 235, 0.12);
    border-color: rgba(37, 99, 235, 0.18);
    color: #1e3a8a;
  }

  .progress-step.current {
    background: rgba(255, 255, 255, 0.96);
    border-color: rgba(37, 99, 235, 0.26);
    box-shadow: 0 16px 32px -26px rgba(37, 99, 235, 0.45);
    color: #1e3a8a;
  }

  .step-number {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    background: rgba(59, 130, 246, 0.15);
    display: grid;
    place-items: center;
    font-weight: 600;
    font-size: 0.95rem;
    color: #1e3a8a;
  }

  .progress-step.complete .step-number {
    background: rgba(59, 130, 246, 0.18);
    color: #1e3a8a;
  }

  .progress-step.current .step-number {
    background: linear-gradient(135deg, #2563eb, #1e3a8a);
    color: white;
  }

  .step-label {
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    color: #1f2937;
  }

  .modal-content {
    display: grid;
    grid-template-columns: 300px minmax(0, 1fr);
    background: #ffffff;
    flex: 1;
    min-height: 0;
  }

  .modal-sidebar {
    position: relative;
    overflow: hidden;
    color: white;
    background: linear-gradient(185deg, #1e3a8a 0%, #2563eb 55%, #60a5fa 100%);
  }

  .modal-sidebar::before,
  .modal-sidebar::after {
    content: '';
    position: absolute;
    border-radius: 50%;
    opacity: 0.4;
    mix-blend-mode: screen;
  }

  .modal-sidebar::before {
    width: 360px;
    height: 360px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.35), transparent 65%);
    top: -110px;
    right: -140px;
  }

  .modal-sidebar::after {
    width: 260px;
    height: 260px;
    background: radial-gradient(circle, rgba(96, 165, 250, 0.4), transparent 70%);
    bottom: -120px;
    left: -80px;
  }

  .sidebar-content {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 1.6rem;
    padding: 2.1rem 2rem 2.3rem;
    height: 100%;
    overflow-y: auto;
  }

  .sidebar-content::-webkit-scrollbar {
    width: 6px;
  }

  .sidebar-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.25);
    border-radius: 999px;
  }

  .sidebar-top {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .sidebar-logo {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.95);
    color: #1e3a8a;
    font-size: 0.68rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    font-weight: 600;
  }

  .sidebar-top h3 {
    font-size: 1.8rem;
    line-height: 1.2;
    letter-spacing: -0.01em;
    margin: 0;
    color: #ffffff;
  }

  .sidebar-top p {
    margin: 0;
    font-size: 1rem;
    line-height: 1.5;
    color: rgba(226, 232, 255, 0.92);
  }

  .sidebar-benefits {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .benefit-item {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.75rem;
    background: rgba(59, 130, 246, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 0.9rem 1rem;
    backdrop-filter: blur(12px);
  }

  .benefit-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.22);
    display: grid;
    place-items: center;
    color: #ffffff;
  }

  .benefit-item strong {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #f8fafc;
    margin-bottom: 0.2rem;
  }

  .benefit-item span {
    font-size: 0.85rem;
    color: rgba(219, 234, 254, 0.82);
  }

  .sidebar-metrics {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem;
  }

  .metric-card {
    padding: 0.85rem 1rem;
    border-radius: 16px;
    background: rgba(37, 99, 235, 0.24);
    border: 1px solid rgba(255, 255, 255, 0.18);
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    color: #f8fafc;
  }

  .metric-card strong {
    font-size: 1.35rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .metric-card span {
    font-size: 0.8rem;
    color: rgba(219, 234, 254, 0.78);
    line-height: 1.4;
  }

  .sidebar-testimonial {
    margin-top: auto;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.85rem;
    padding: 1rem 1.1rem;
    border-radius: 16px;
    background: rgba(30, 64, 175, 0.32);
    border: 1px solid rgba(255, 255, 255, 0.16);
    backdrop-filter: blur(14px);
  }

  .testimonial-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    font-weight: 700;
    font-size: 1.1rem;
    background: linear-gradient(135deg, #fde68a, #f472b6);
    color: #1e293b;
  }

  .sidebar-testimonial p {
    margin: 0 0 0.4rem 0;
    font-size: 0.9rem;
    line-height: 1.6;
    color: rgba(219, 234, 254, 0.92);
  }

  .sidebar-testimonial span {
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(226, 232, 255, 0.7);
  }

  .modal-form {
    position: relative;
    padding: 2.2rem 2.5rem 2rem;
    background: linear-gradient(165deg, rgba(248, 250, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 60%, rgba(248, 250, 255, 0.98) 100%);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
    min-height: 0;
  }

  .modal-form::-webkit-scrollbar {
    width: 8px;
  }

  .modal-form::-webkit-scrollbar-thumb {
    background: rgba(148, 163, 184, 0.45);
    border-radius: 999px;
  }

  .modal-form::-webkit-scrollbar-track {
    background: transparent;
  }

  .form-step {
    display: none;
    animation: fadeStep 0.35s ease;
  }

  .form-step.active {
    display: block;
  }

  @keyframes fadeStep {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .form-step h2 {
    font-size: 1.9rem;
    line-height: 1.2;
    color: #0f172a;
    margin-bottom: 0.65rem;
  }

  .step-description {
    color: #475467;
    margin-bottom: 1.75rem;
    font-size: 0.98rem;
    line-height: 1.6;
  }

  .form-group {
    margin-bottom: 1.15rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #1e3a8a;
    margin-bottom: 0.45rem;
    font-size: 0.72rem;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.68rem 0.95rem;
    font-size: 0.94rem;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.26);
    background: rgba(255, 255, 255, 0.95);
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  .form-group textarea {
    min-height: 120px;
  }

  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: rgba(148, 163, 184, 0.85);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: rgba(37, 99, 235, 0.65);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    background: #ffffff;
  }

  .form-group .error-message {
    color: #e11d48;
  }

  .form-group input.error,
  .form-group select.error,
  .form-group textarea.error {
    border-color: #e11d48;
    box-shadow: 0 0 0 3px rgba(225, 29, 72, 0.12);
  }

  .phone-input {
    display: grid;
    grid-template-columns: 160px minmax(0, 1fr);
    gap: 0.6rem;
  }

  .form-checkbox {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.85rem;
    align-items: flex-start;
    margin-bottom: 1.5rem;
  }

  .form-checkbox input[type="checkbox"] {
    margin-top: 0.2rem;
    width: 1.1rem;
    height: 1.1rem;
    border-radius: 4px;
    border: 1px solid rgba(148, 163, 184, 0.8);
    cursor: pointer;
  }

  .form-checkbox input[type="checkbox"].error {
    outline: 2px solid rgba(225, 29, 72, 0.6);
    outline-offset: 2px;
    border-color: rgba(225, 29, 72, 0.6);
  }

  .form-checkbox label {
    font-size: 0.9rem;
    color: #475467;
    line-height: 1.5;
    cursor: pointer;
  }

  .form-checkbox label a {
    color: #1e3a8a;
    font-weight: 600;
  }

  .error-message {
    margin-top: 0.35rem;
    display: block;
    color: #e11d48;
    font-size: 0.78rem;
  }

  .calendar-container {
    border-radius: 24px;
    padding: 2rem;
    background: linear-gradient(160deg, rgba(248, 250, 255, 0.95), rgba(224, 231, 255, 0.85));
    border: 1px solid rgba(37, 99, 235, 0.22);
    box-shadow: 0 30px 60px -40px rgba(37, 99, 235, 0.3);
  }

  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.75rem;
  }

  .calendar-nav {
    width: 2.4rem;
    height: 2.4rem;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(255, 255, 255, 0.85);
    display: grid;
    place-items: center;
    color: #1f2937;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .calendar-nav:hover {
    border-color: rgba(37, 99, 235, 0.45);
    color: #1e3a8a;
    transform: translateY(-2px);
    box-shadow: 0 14px 28px -18px rgba(37, 99, 235, 0.45);
  }

  .calendar-month {
    font-size: 1.35rem;
    font-weight: 700;
    color: #1f2937;
    letter-spacing: -0.01em;
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap: 0.45rem;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid rgba(148, 163, 184, 0.25);
  }

  .calendar-weekdays span {
    text-align: center;
    font-size: 0.75rem;
    font-weight: 700;
    color: rgba(30, 64, 175, 0.85);
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, minmax(0, 1fr));
    gap: 0.45rem;
  }

  .calendar-day {
    aspect-ratio: 1;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.88);
    border: 1px solid rgba(148, 163, 184, 0.25);
    display: grid;
    place-items: center;
    font-weight: 600;
    color: #1f2a5a;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .calendar-day.available {
    background: rgba(37, 99, 235, 0.12);
    border-color: rgba(37, 99, 235, 0.35);
    color: #1e3a8a;
  }

  .calendar-day:hover:not(.disabled):not(.selected) {
    transform: translateY(-3px);
    box-shadow: 0 18px 32px -24px rgba(37, 99, 235, 0.4);
    border-color: rgba(37, 99, 235, 0.5);
  }

  .calendar-day.selected,
  .calendar-day[data-selected="true"] {
    background: linear-gradient(140deg, #2563eb, #1d4ed8);
    color: white;
    border-color: transparent;
    transform: scale(1.06);
    box-shadow: 0 18px 34px -16px rgba(37, 99, 235, 0.45);
  }

  .calendar-day.selected::after,
  .calendar-day[data-selected="true"]::after {
    display: none;
  }

  .calendar-day.disabled {
    opacity: 0.35;
    cursor: not-allowed;
    background: rgba(248, 250, 252, 0.6);
  }

  .time-slots {
    margin-top: 1.75rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .time-slots h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
  }

  .slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.75rem;
  }

  .time-slot {
    padding: 0.75rem;
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.4);
    background: rgba(255, 255, 255, 0.92);
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .time-slot:hover {
    border-color: rgba(37, 99, 235, 0.55);
    color: #1e3a8a;
    transform: translateY(-2px);
  }

  .time-slot.selected {
    border-color: transparent;
    background: linear-gradient(135deg, #2563eb, #1e3a8a);
    color: white;
    box-shadow: 0 16px 32px -22px rgba(37, 99, 235, 0.45);
  }

  @keyframes confirmSelection {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.04);
    }
    100% {
      transform: scale(1);
    }
  }

  .flexible-option {
    margin-top: 1.25rem;
  }

  .flexible-btn {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    border-radius: 14px;
    border: 1px dashed rgba(37, 99, 235, 0.45);
    background: rgba(37, 99, 235, 0.12);
    color: #1e3a8a;
    font-weight: 600;
    padding: 0.9rem 1.1rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .flexible-btn:hover,
  .flexible-btn.selected {
    background: rgba(37, 99, 235, 0.18);
  }

  .confirmation-summary {
    border-radius: 22px;
    background: linear-gradient(160deg, rgba(248, 250, 252, 0.95), rgba(226, 232, 240, 0.6));
    border: 1px solid rgba(148, 163, 184, 0.3);
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .summary-section h3 {
    margin: 0 0 0.9rem;
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2a5a;
  }

  .summary-list {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.6rem 1.2rem;
    font-size: 0.95rem;
    color: #1f2937;
  }

  .summary-list dt {
    font-weight: 500;
    color: #64748b;
  }

  .summary-list dd {
    margin: 0;
    font-weight: 600;
    color: #0f172a;
  }

  .appointment-card {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
    align-items: center;
    padding: 1.1rem 1.25rem;
    background: rgba(255, 255, 255, 0.92);
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, 0.35);
  }

  .terms-section .error-message {
    margin-top: 0.6rem;
  }

  .additional-info {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .additional-info label {
    font-size: 0.82rem;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #1e3a8a;
  }

  .form-success {
    text-align: center;
    padding: 3rem 1rem;
  }

  .success-icon {
    margin-bottom: 1.5rem;
  }

  .success-icon svg {
    color: #22c55e;
  }

  .form-success h2 {
    font-size: 2rem;
    margin-bottom: 0.75rem;
    color: #0f172a;
  }

  .form-success p {
    color: #475467;
    margin-bottom: 0.4rem;
  }

  .success-detail {
    color: #1e3a8a;
    font-weight: 600;
  }

  .success-actions {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .form-navigation {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 1rem;
    margin-top: 1.25rem;
    padding-top: 1.25rem;
    border-top: 1px solid rgba(226, 232, 240, 0.8);
  }

  .form-navigation .btn-back {
    margin-right: auto;
  }

  .btn-back,
  .btn-next,
  .btn-primary,
  .btn-secondary {
    border: none;
    border-radius: 14px;
    padding: 0.95rem 1.75rem;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  .btn-back {
    background: #ffffff;
    border: 1px solid rgba(148, 163, 184, 0.35);
    color: #475467;
  }

  .btn-back:hover {
    border-color: rgba(37, 99, 235, 0.45);
    color: #1e3a8a;
    transform: translateY(-1px);
  }

  .btn-next,
  .btn-primary {
    background: linear-gradient(135deg, #2563eb, #1e3a8a);
    color: white;
    box-shadow: 0 18px 40px -24px rgba(37, 99, 235, 0.45);
  }

  .btn-next:hover,
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 26px 50px -24px rgba(30, 64, 175, 0.55);
  }

  .btn-secondary {
    background: rgba(148, 163, 184, 0.15);
    color: #1f2a5a;
  }

  .btn-secondary:hover {
    background: rgba(148, 163, 184, 0.25);
  }

  .children-fields {
    border-radius: 16px;
    border: 1px dashed rgba(37, 99, 235, 0.35);
    padding: 1.25rem 1.4rem;
    background: rgba(37, 99, 235, 0.08);
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1180px) {
    .modal-container {
      width: min(960px, calc(100% - 2.5rem));
    }

    .modal-progress {
      padding: 1.8rem 2.2rem 1.3rem;
    }

    .modal-form {
      padding: 2rem 2.2rem 1.8rem;
    }
  }

  @media (max-width: 1024px) {
    .modal-content {
      grid-template-columns: 1fr;
      background: #ffffff;
    }

    .modal-sidebar {
      display: none;
    }

    .modal-form {
      padding: 2rem 1.8rem 1.8rem;
    }

    .modal-progress {
      padding: 1.7rem 1.8rem 1.2rem;
    }

    .modal-container {
      width: 100%;
      height: 100%;
      max-height: 100vh;
      border-radius: 0;
    }

    .modal-close {
      top: 1rem;
      right: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.85);
    }

    .form-navigation {
      padding: 1.1rem 2rem 1.4rem;
    }
  }

  @media (max-width: 640px) {
    .modal-progress {
      padding: 1.6rem 1.5rem 1.25rem;
    }

    .progress-steps {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.6rem;
    }

    .progress-step {
      padding: 0.75rem 0.6rem;
      gap: 0.6rem;
    }

    .step-label {
      font-size: 0.78rem;
    }

    .step-number {
      width: 40px;
      height: 40px;
    }

    .modal-form {
      padding: 1.75rem 1.5rem;
    }

    .phone-input {
      grid-template-columns: 120px minmax(0, 1fr);
    }

    .slots-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .form-navigation {
      flex-direction: column;
      align-items: stretch;
      padding-top: 1rem;
      gap: 0.75rem;
    }

    .form-navigation .btn-back {
      margin-right: 0;
    }

    .btn-back,
    .btn-next {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  // Registration Modal JavaScript
  let currentStep = 1;
  const totalSteps = 3;
  let formData = {};
  let selectedDate = null;
  let selectedTime = null;

  function initRegistrationModal() {
    const modal = document.getElementById('registrationModal');
    const overlay = modal?.querySelector('.modal-overlay');
    const closeBtn = modal?.querySelector('.modal-close');
    const backBtn = modal?.querySelector('.btn-back');
    const nextBtn = modal?.querySelector('.btn-next');
    const courseSelect = document.getElementById('courseInterest');
    const childrenFields = document.getElementById('childrenFields');

    // Course type change handler
    courseSelect?.addEventListener('change', function() {
      if (this.value === 'children') {
        childrenFields.style.display = 'block';
      } else {
        childrenFields.style.display = 'none';
      }
    });

    if (courseSelect && childrenFields) {
      childrenFields.style.display = courseSelect.value === 'children' ? 'block' : 'none';
    }

    // Navigation handlers
    backBtn?.addEventListener('click', () => navigateStep('back'));
    nextBtn?.addEventListener('click', () => navigateStep('next'));
    overlay?.addEventListener('click', closeModal);
    closeBtn?.addEventListener('click', closeModal);

    // Initialize calendar
    initCalendar();

    // Form validation
    initFormValidation();

    // Auto-save to localStorage
    initAutoSave();

    // Ensure initial UI state is synced
    updateModalStep();
  }

  function openRegistrationModal(courseType, location) {
    const modal = document.getElementById('registrationModal');
    if (modal) {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      resetModalState();

      // Set default values if provided
      const courseSelect = document.getElementById('courseInterest');
      const locationSelect = document.getElementById('location');

      // Load saved data if exists
      loadSavedData();

      if (courseSelect) {
        const hasCourseType = typeof courseType === 'string' && courseType.trim().length > 0;
        if (hasCourseType) {
          courseSelect.value = courseType;
          formData.courseInterest = courseType;
        } else if (!courseSelect.value) {
          courseSelect.value = 'adults';
          formData.courseInterest = 'adults';
        }
        const childrenFields = document.getElementById('childrenFields');
        if (childrenFields) {
          childrenFields.style.display = courseSelect.value === 'children' ? 'block' : 'none';
        }
      }

      if (locationSelect) {
        const hasLocation = typeof location === 'string' && location.trim().length > 0;
        if (hasLocation) {
          locationSelect.value = location;
          formData.location = location;
        }
      }

      updateModalStep();
    }
  }

  function closeModal() {
    const modal = document.getElementById('registrationModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  window.closeRegistrationModal = closeModal;

  function navigateStep(direction) {
    if (direction === 'next') {
      if (!validateCurrentStep()) return;

      if (currentStep === totalSteps) {
        submitRegistration();
        return;
      }

      saveStepData();
      currentStep++;
    } else if (direction === 'back' && currentStep > 1) {
      currentStep--;
    }

    updateModalStep();
  }

  function resetModalState() {
    currentStep = 1;
    formData = {};
    selectedDate = null;
    selectedTime = null;
    window.selectedDateElement = null;
    window.selectedTimeSlot = null;

    const successState = document.querySelector('.form-success');
    if (successState) {
      successState.style.display = 'none';
    }

    const nav = document.querySelector('.form-navigation');
    if (nav) {
      nav.style.display = '';
    }

    const timeSlotsContainer = document.getElementById('timeSlots');
    if (timeSlotsContainer) {
      timeSlotsContainer.style.display = 'none';
      timeSlotsContainer.style.opacity = '1';
      timeSlotsContainer.querySelector('.slots-grid')?.replaceChildren();
    }

    document.querySelectorAll('.calendar-day.selected').forEach(day => {
      day.classList.remove('selected');
      day.setAttribute('data-selected', 'false');
    });

    document.querySelectorAll('.time-slot.selected').forEach(slot => {
      slot.classList.remove('selected');
      slot.setAttribute('data-selected', 'false');
      slot.setAttribute('aria-pressed', 'false');
    });

    document.querySelector('.flexible-btn')?.classList.remove('selected');

    document.querySelectorAll('.error-message').forEach(message => {
      message.textContent = '';
    });

    document.querySelectorAll('.error').forEach(field => {
      field.classList.remove('error');
    });

    updateModalStep();
  }

  function updateModalStep() {
    // Update progress bar
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
      progressFill.setAttribute('data-step', currentStep);
    }

    // Update progress steps
    document.querySelectorAll('.progress-step').forEach((step, index) => {
      const stepNumber = index + 1;
      const isCurrent = stepNumber === currentStep;
      const isComplete = stepNumber < currentStep;

      step.classList.toggle('active', stepNumber <= currentStep);
      step.classList.toggle('current', isCurrent);
      step.classList.toggle('complete', isComplete);
    });

    // Update form steps
    document.querySelectorAll('.form-step').forEach(step => {
      const stepNum = parseInt(step.getAttribute('data-step'));
      step.classList.toggle('active', stepNum === currentStep);
    });

    // Update buttons
    const backBtn = document.querySelector('.btn-back');
    const nextBtn = document.querySelector('.btn-next');

    if (backBtn) {
      backBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
    }

    if (nextBtn) {
      const label = nextBtn.querySelector('.btn-label');
      const text = currentStep === totalSteps ? 'Complete Registration' : 'Continue';
      if (label) {
        label.textContent = text;
      } else {
        nextBtn.textContent = text;
      }
    }

    // Update summary if on confirmation step
    if (currentStep === 3) {
      updateConfirmationSummary();
    }
  }

  function validateCurrentStep() {
    const currentFormStep = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    const requiredFields = currentFormStep?.querySelectorAll('[required]');
    let isValid = true;

    requiredFields?.forEach(field => {
      if (!field.value.trim()) {
        showFieldError(field, 'This field is required');
        isValid = false;
      } else if (field.type === 'email' && !validateEmail(field.value)) {
        showFieldError(field, 'Please enter a valid email address');
        isValid = false;
      } else {
        clearFieldError(field);
      }
    });

    // Special validation for step 2 (calendar)
    if (currentStep === 2) {
      const flexibleBtn = document.querySelector('.flexible-btn');
      if (!selectedDate && !selectedTime && !flexibleBtn?.classList.contains('selected')) {
        alert('Please select a consultation time or choose the flexible option');
        isValid = false;
      }
    }

    // Special validation for step 3 (terms)
    if (currentStep === 3) {
      const termsCheckbox = document.getElementById('terms');
      if (!termsCheckbox?.checked) {
        showFieldError(termsCheckbox, 'You must accept the terms and conditions');
        isValid = false;
      }
    }

    return isValid;
  }

  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function getErrorElement(field) {
    return field.parentElement?.querySelector('.error-message')
      || field.closest('.form-group')?.querySelector('.error-message')
      || field.closest('.terms-section')?.querySelector('.error-message');
  }

  function showFieldError(field, message) {
    const errorElement = getErrorElement(field);
    if (errorElement) {
      errorElement.textContent = message;
      field.classList.add('error');
    }
  }

  function clearFieldError(field) {
    const errorElement = getErrorElement(field);
    if (errorElement) {
      errorElement.textContent = '';
      field.classList.remove('error');
    }
  }

  function saveStepData() {
    const inputs = document.querySelectorAll(`.form-step[data-step="${currentStep}"] input, .form-step[data-step="${currentStep}"] select, .form-step[data-step="${currentStep}"] textarea`);

    inputs.forEach(input => {
      if (input.type === 'checkbox') {
        formData[input.name] = input.checked;
      } else if (input.type === 'radio') {
        if (input.checked) {
          formData[input.name] = input.value;
        }
      } else {
        formData[input.name] = input.value;
      }
    });

    // Save calendar selection
    if (currentStep === 2) {
      formData.selectedDate = selectedDate;
      formData.selectedTime = selectedTime;
    }

    // Save to localStorage
    localStorage.setItem('registrationFormData', JSON.stringify(formData));
  }

  function loadSavedData() {
    const savedData = localStorage.getItem('registrationFormData');
    if (savedData) {
      formData = JSON.parse(savedData);

      // Populate form fields
      Object.keys(formData).forEach(key => {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) {
          if (field.type === 'checkbox') {
            field.checked = formData[key];
          } else {
            field.value = formData[key];
          }
        }
      });
    }
  }

  function initAutoSave() {
    const inputs = document.querySelectorAll('.modal-form input, .modal-form select, .modal-form textarea');

    inputs.forEach(input => {
      input.addEventListener('change', () => {
        saveStepData();
      });
    });
  }

  function initCalendar() {
    const calendarDays = document.getElementById('calendarDays');
    const currentDate = new Date();

    // Use an object to track current displayed month/year
    const calendarState = {
      month: currentDate.getMonth(),
      year: currentDate.getFullYear()
    };

    if (calendarDays) {
      renderCalendar(calendarState.month, calendarState.year);
    }

    // Calendar navigation with state updates
    document.querySelector('.calendar-nav.prev')?.addEventListener('click', () => {
      calendarState.month--;
      if (calendarState.month < 0) {
        calendarState.month = 11;
        calendarState.year--;
      }
      renderCalendar(calendarState.month, calendarState.year);
    });

    document.querySelector('.calendar-nav.next')?.addEventListener('click', () => {
      calendarState.month++;
      if (calendarState.month > 11) {
        calendarState.month = 0;
        calendarState.year++;
      }
      renderCalendar(calendarState.month, calendarState.year);
    });

    // Flexible button
    document.querySelector('.flexible-btn')?.addEventListener('click', function() {
      this.classList.toggle('selected');
      selectedDate = 'flexible';
      selectedTime = 'flexible';
    });
  }

  function renderCalendar(month, year) {
    const calendarDays = document.getElementById('calendarDays');
    if (!calendarDays) return;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    calendarDays.innerHTML = '';

    // Empty cells before first day
    for (let i = 0; i < (firstDay || 7) - 1; i++) {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'calendar-day disabled';
      calendarDays.appendChild(emptyDiv);
    }

    // Calendar days - make all future weekdays available
    for (let day = 1; day <= daysInMonth; day++) {
      const dayDate = new Date(year, month, day);
      dayDate.setHours(0, 0, 0, 0);
      const isToday = dayDate.getTime() === today.getTime();
      const isPast = dayDate < today;
      const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;

      const dayButton = document.createElement('button');
      dayButton.type = 'button';
      dayButton.className = 'calendar-day';
      dayButton.textContent = day;
      dayButton.setAttribute('data-date', dayDate.toISOString().split('T')[0]);
      dayButton.setAttribute('data-selected', 'false');
      dayButton.setAttribute('aria-pressed', 'false');
      dayButton.setAttribute('aria-label', `Select ${dayDate.toLocaleDateString()}`);

      if (isToday) dayButton.classList.add('today');

      if (isPast) {
        dayButton.classList.add('disabled');
        dayButton.disabled = true;
      } else if (isWeekend) {
        dayButton.classList.add('disabled');
        dayButton.disabled = true;
      } else {
        // All future weekdays are available
        dayButton.classList.add('available');
        dayButton.addEventListener('click', (e) => selectDate(dayDate, e));

        // Restore selection if this was previously selected
        if (window.selectedDateElement &&
            window.selectedDateElement.date === day &&
            window.selectedDateElement.month === month &&
            window.selectedDateElement.year === year) {
          dayButton.classList.add('selected');
        }
      }

      calendarDays.appendChild(dayButton);
    }

    // Update month display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    const monthDisplay = document.querySelector('.calendar-month');
    if (monthDisplay) {
      monthDisplay.textContent = `${monthNames[month]} ${year}`;
    }
  }

  function selectDate(date, event) {
    selectedDate = date;

    // Update visual selection - remove from all days first
    document.querySelectorAll('.calendar-day').forEach(day => {
      day.classList.remove('selected');
      day.setAttribute('data-selected', 'false');
      day.setAttribute('aria-pressed', 'false');
    });

    // Add selected class to clicked element
    if (event && event.currentTarget) {
      event.currentTarget.classList.add('selected');
      event.currentTarget.setAttribute('data-selected', 'true');
      event.currentTarget.setAttribute('aria-pressed', 'true');

      // Force style recalculation to ensure CSS is applied
      void event.currentTarget.offsetHeight;

      // Store the selected date element to maintain selection when navigating months
      window.selectedDateElement = {
        date: date.getDate(),
        month: date.getMonth(),
        year: date.getFullYear()
      };
    }

    // Show time slots
    showTimeSlots(date);
  }

  function showTimeSlots(date) {
    const timeSlotsContainer = document.getElementById('timeSlots');
    const slotsGrid = timeSlotsContainer?.querySelector('.slots-grid');

    if (timeSlotsContainer && slotsGrid) {
      timeSlotsContainer.style.display = 'block';

      // Generate available time slots
      const morningSlots = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30'];
      const afternoonSlots = ['14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'];

      // Show most slots, randomly remove just a few to simulate bookings
      const allSlots = [...morningSlots, ...afternoonSlots];
      const availableSlots = allSlots.filter(() => Math.random() > 0.15); // 85% chance each slot is available

      // Ensure at least some slots are always available
      if (availableSlots.length < 4) {
        availableSlots.push(...allSlots.slice(0, 6));
      }

      slotsGrid.innerHTML = '';

      // Add a smooth fade-in animation
      timeSlotsContainer.style.opacity = '0';
      setTimeout(() => {
        timeSlotsContainer.style.transition = 'opacity 0.3s ease';
        timeSlotsContainer.style.opacity = '1';
      }, 10);

      availableSlots.forEach((time, index) => {
        const slot = document.createElement('button');
        slot.type = 'button';
        slot.className = 'time-slot';
        slot.textContent = time;
        slot.setAttribute('data-time', time);
        slot.setAttribute('data-selected', 'false');
        slot.setAttribute('aria-pressed', 'false');
        slot.setAttribute('aria-label', `Select ${time} consultation time`);
        slot.style.animationDelay = `${index * 30}ms`;
        slot.style.animation = 'fadeInUp 0.4s ease forwards';
        slot.addEventListener('click', (e) => selectTime(time, e));

        // Restore selection if this time was previously selected
        if (window.selectedTimeSlot === time) {
          slot.classList.add('selected');
        }

        slotsGrid.appendChild(slot);
      });

      // Add keyframe animation if not already present
      if (!document.getElementById('timeSlotAnimation')) {
        const style = document.createElement('style');
        style.id = 'timeSlotAnimation';
        style.textContent = `
          @keyframes fadeInUp {
            from {
              opacity: 0;
              transform: translateY(10px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(style);
      }
    }
  }

  function selectTime(time, event) {
    selectedTime = time;

    // Update visual selection - remove from all slots first
    document.querySelectorAll('.time-slot').forEach(slot => {
      slot.classList.remove('selected');
      slot.setAttribute('data-selected', 'false');
      slot.setAttribute('aria-pressed', 'false');
    });

    // Add selected class to clicked element
    if (event && event.currentTarget) {
      event.currentTarget.classList.add('selected');
      event.currentTarget.setAttribute('data-selected', 'true');
      event.currentTarget.setAttribute('aria-pressed', 'true');

      // Force style recalculation
      void event.currentTarget.offsetHeight;

      // Store the selected time to maintain state
      window.selectedTimeSlot = time;

      // Add a subtle animation to confirm selection
      event.currentTarget.style.animation = 'confirmSelection 0.3s ease';
      setTimeout(() => {
        if (event.currentTarget) {
          event.currentTarget.style.animation = '';
        }
      }, 300);
    }
  }

  function updateConfirmationSummary() {
    document.getElementById('summaryName').textContent = formData.fullName || '-';
    document.getElementById('summaryEmail').textContent = formData.email || '-';
    document.getElementById('summaryPhone').textContent = `${formData.phoneCode || ''} ${formData.phone || '-'}`;
    document.getElementById('summaryCourse').textContent = formData.courseInterest || '-';
    document.getElementById('summaryLocation').textContent = formData.location || '-';

    if (selectedDate === 'flexible') {
      document.getElementById('summaryDate').textContent = 'Flexible scheduling requested';
      document.getElementById('summaryTime').textContent = 'We will contact you with options';
    } else if (selectedDate && selectedTime) {
      document.getElementById('summaryDate').textContent = selectedDate.toLocaleDateString();
      document.getElementById('summaryTime').textContent = selectedTime;
    }
  }

  function submitRegistration() {
    saveStepData();

    // Hide form and show success
    document.querySelectorAll('.form-step').forEach(step => {
      step.classList.remove('active');
    });
    const nav = document.querySelector('.form-navigation');
    if (nav) nav.style.display = 'none';
    document.querySelector('.form-success').style.display = 'block';

    // Clear saved data
    localStorage.removeItem('registrationFormData');
    formData = {};

    // Send confirmation email (would be handled by backend)
    // ...
  }

  function initFormValidation() {
    // Real-time validation for email
    document.getElementById('email')?.addEventListener('blur', function() {
      if (this.value && !validateEmail(this.value)) {
        showFieldError(this, 'Please enter a valid email address');
      } else {
        clearFieldError(this);
      }
    });

    // Real-time validation for phone
    document.getElementById('phone')?.addEventListener('blur', function() {
      if (this.value && !/^\d{9,}$/.test(this.value.replace(/\s/g, ''))) {
        showFieldError(this, 'Please enter a valid phone number');
      } else {
        clearFieldError(this);
      }
    });
  }

  // Initialize on DOM load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRegistrationModal);
  } else {
    // DOM is already loaded
    initRegistrationModal();
  }

  // Export function for use in other components
  window.openRegistrationModal = openRegistrationModal;
</script>
